

services:
  # API Gateway
  api-gateway:
    build:
      context: .
      dockerfile: ./services/api-gateway/Dockerfile
    ports:
      - '4000:4000'
    environment:
      - NODE_ENV=development
      - PORT=4000
      - JWT_SECRET=${JWT_SECRET}
      - CORS_ORIGIN=${CORS_ORIGIN}
      - CORS_CREDENTIALS=${CORS_CREDENTIALS}
      - AUTH_SERVICE_URL=http://auth-service:4001
      - USER_SERVICE_URL=http://user-service:4002
      - COURSE_SERVICE_URL=http://course-service:4003
      - ATTENDANCE_SERVICE_URL=http://attendance-service:4004
      - GRADE_SERVICE_URL=http://grade-service:4005
      - CONTENT_SERVICE_URL=http://content-service:4006
    depends_on:
      - auth-service
      - user-service
      - course-service
      - attendance-service
      - grade-service
      - content-service
    networks:
      - e-system-network
    restart: unless-stopped

  # Auth Service
  auth-service:
    build:
      context: .
      dockerfile: ./services/auth/Dockerfile
    ports:
      - '4001:4001'
    environment:
      - NODE_ENV=development
      - PORT=4001
      - MONGO_URI=${MONGO_URI_AUTH}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN}
      - ADMIN_SIGNUP_CODE=${ADMIN_SIGNUP_CODE}
    networks:
      - e-system-network
    restart: unless-stopped

  # User Service
  user-service:
    build:
      context: .
      dockerfile: ./services/user/Dockerfile
    ports:
      - '4002:4002'
    environment:
      - NODE_ENV=development
      - PORT=4002
      - MONGO_URI=${MONGO_URI_USER}
    volumes:
      - ./uploads:/app/uploads
    networks:
      - e-system-network
    restart: unless-stopped

  # Course Service
  course-service:
    build:
      context: .
      dockerfile: ./services/course/Dockerfile
    ports:
      - '4003:4003'
    environment:
      - NODE_ENV=development
      - PORT=4003
      - MONGO_URI=${MONGO_URI_COURSE}
      - USER_SERVICE_URL=http://user-service:4002
    networks:
      - e-system-network
    restart: unless-stopped

  # Attendance Service
  attendance-service:
    build:
      context: .
      dockerfile: ./services/attendance/Dockerfile
    ports:
      - '4004:4004'
    environment:
      - NODE_ENV=development
      - PORT=4004
      - MONGO_URI=${MONGO_URI_ATTENDANCE}
      - COURSE_SERVICE_URL=http://course-service:4003
      - USER_SERVICE_URL=http://user-service:4002
    networks:
      - e-system-network
    restart: unless-stopped

  # Grade Service
  grade-service:
    build:
      context: .
      dockerfile: ./services/grade/Dockerfile
    ports:
      - '4005:4005'
    environment:
      - NODE_ENV=development
      - PORT=4005
      - MONGO_URI=${MONGO_URI_GRADE}
      - COURSE_SERVICE_URL=http://course-service:4003
      - USER_SERVICE_URL=http://user-service:4002
    networks:
      - e-system-network
    restart: unless-stopped

  # Content Service
  content-service:
    build:
      context: .
      dockerfile: ./services/content/Dockerfile
    ports:
      - '4006:4006'
    environment:
      - NODE_ENV=development
      - PORT=4006
      - MONGO_URI=${MONGO_URI_CONTENT}
      - COURSE_SERVICE_URL=http://course-service:4003
      - USER_SERVICE_URL=http://user-service:4002
      - GEMINI_API_KEY=${GEMINI_API_KEY}
    networks:
      - e-system-network
    restart: unless-stopped

  # MongoDB (Commented out as we are using Atlas)
  # mongo:
  #   image: mongo:6.0
  #   ports:
  #     - '27017:27017'
  #   environment:
  #     - MONGO_INITDB_ROOT_USERNAME=root
  #     - MONGO_INITDB_ROOT_PASSWORD=rootpassword
  #   volumes:
  #     - mongodb_data:/data/db
  #   networks:
  #     - e-system-network
  #   restart: unless-stopped

  # Mongo Express (Optional - for database management)
  # mongo-express:
  #   image: mongo-express:latest
  #   ports:
  #     - '8081:8081'
  #   environment:
  #     - ME_CONFIG_MONGODB_SERVER=mongo
  #     - ME_CONFIG_MONGODB_PORT=27017
  #     - ME_CONFIG_MONGODB_ENABLE_ADMIN=true
  #     - ME_CONFIG_MONGODB_ADMINUSERNAME=root
  #     - ME_CONFIG_MONGODB_ADMINPASSWORD=rootpassword
  #     - ME_CONFIG_BASICAUTH_USERNAME=admin
  #     - ME_CONFIG_BASICAUTH_PASSWORD=admin123
  #   depends_on:
  #     - mongo
  #   networks:
  #     - e-system-network
  #   restart: unless-stopped

networks:
  e-system-network:
    driver: bridge

volumes:
  mongodb_data:
